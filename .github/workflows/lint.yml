name: Lint

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Install ShellCheck
        run: apt-get update && apt-get install -y shellcheck
      
      - name: Run ShellCheck
        run: |
          find src tests -name '*.sh' -type f | xargs shellcheck --config=.shellcheckrc || exit 1
          echo "✓ ShellCheck passed"

  conventional-commits:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Validate Conventional Commits
        run: |
          # Check commit messages on develop and feature branches
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_COMMIT=${{ github.event.pull_request.base.sha }}
            HEAD_COMMIT=${{ github.event.pull_request.head.sha }}
          else
            BASE_COMMIT="HEAD~1"
            HEAD_COMMIT="HEAD"
          fi
          
          git log --format=%B $BASE_COMMIT..$HEAD_COMMIT | grep -E '^(feat|fix|perf|refactor|docs|test|ci|chore)(\(.+\))?: ' || {
            echo "✗ Commit messages must follow Conventional Commits format"
            echo "  Format: type(scope): subject"
            echo "  Example: feat(core): add TTL spoofing support"
            exit 1
          }
          echo "✓ Conventional Commits validated"

  lint-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Check markdown links
        run: |
          # Check for broken internal links
          find . -name '*.md' -type f | while read file; do
            grep -o '\[.*\]\(.*\)' "$file" | grep -o '\(.*\)' | sed 's/[()]//g' | while read link; do
              if [[ "$link" == ./* ]]; then
                if [ ! -f "$link" ]; then
                  echo "✗ Broken link in $file: $link"
                  exit 1
                fi
              fi
            done
          done
          echo "✓ Documentation links validated"
