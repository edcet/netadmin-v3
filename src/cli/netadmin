#!/bin/sh
# netadmin v3.0 - Main CLI Interface
# Usage: netadmin <command> [options]

set -u

NETADMIN_ROOT="${NETADMIN_ROOT:-/jffs/scripts/netadmin}"
NETADMIN_VERSION="3.0.0"

# Source core library
. "$NETADMIN_ROOT/core/netadmin-lib.sh"

show_help() {
    cat << EOF
netadmin v$NETADMIN_VERSION - WAN Management Framework for ASUSWRT-Merlin

Usage: netadmin <command> [options]

Commands:
  profile <name>        Switch to profile (safe, verizon, verizon-bypass)
  wan-state            Show WAN health status (JSON)
  get-state            Show current state machine state
  show-config          Show current configuration
  show-hardware        Show hardware acceleration status
  metrics [export|show|start-http]  Manage Prometheus metrics
  logs [tail <N>]      Show state machine logs
  health-check         Run immediate WAN health check
  verify               Verify rules are applied correctly
  migrate              Migrate from v2.1 (requires --from-v2.1)
  rollback             Rollback to last known good state
  help                 Show this help message
  version              Show version information

Examples:
  netadmin profile verizon
  netadmin wan-state
  netadmin metrics show
  netadmin logs tail 20
  netadmin health-check

EOF
}

show_version() {
    echo "netadmin v$NETADMIN_VERSION"
    echo "Framework for ASUSWRT-Merlin WAN management"
    echo ""
    echo "Repository: https://github.com/edcet/netadmin-v3"
    echo "Documentation: https://github.com/edcet/netadmin-v3/tree/main/docs"
}

profile_switch() {
    local profile="$1"
    
    case "$profile" in
        safe|verizon|verizon-bypass)
            echo "Switching to $profile profile..."
            
            # Validate hardware compatibility
            if ! validate_hardware_for_profile "$profile"; then
                echo "ERROR: Hardware validation failed for $profile"
                return 1
            fi
            
            # Apply rules
            if apply_rules "$profile"; then
                nvram_set "netadmin_mode" "$profile"
                nvram_commit
                set_state "$STATE_ACTIVE"
                echo "✓ Switched to $profile profile"
            else
                echo "ERROR: Failed to apply $profile profile"
                apply_rules "safe"
                return 1
            fi
            ;;
        *)
            echo "ERROR: Unknown profile: $profile"
            echo "Available profiles: safe, verizon, verizon-bypass"
            return 1
            ;;
    esac
}

show_wan_state() {
    # Update health first
    "$NETADMIN_ROOT"/core/wan-state.sh >/dev/null 2>&1
    
    # Show JSON
    if [ -f "$NETADMIN_HEALTH_JSON" ]; then
        cat "$NETADMIN_HEALTH_JSON"
    else
        echo '{"error": "Health data not available"}'
        return 1
    fi
}

show_state() {
    local state
    state="$(get_current_state)"
    echo "Current State: $(state_name "$state") ($state)"
}

show_config() {
    local mode
    mode="$(nvram_get netadmin_mode safe)"
    
    echo "netadmin Configuration"
    echo "======================"
    echo "Profile:       $mode"
    echo "State:         $(state_name "$(get_current_state)")"
    echo "TTL Mode:      $(nvram_get netadmin_ttl_mode off)"
    echo "Zapret:        $(nvram_get netadmin_zapret 0)"
    echo "WAN Interface: $(wan_if_detect)"
    echo ""
    echo "Hardware Acceleration:"
    get_hardware_accel_status | sed 's/^/  /'
}

show_hardware() {
    echo "Hardware Acceleration Status"
    echo "============================"
    echo "CTF (Cut-Through Forwarding):  $([ "$(check_ctf_status)" = "1" ] && echo "ENABLED" || echo "DISABLED")"
    echo "FC (Flow Accelerator):         $([ "$(check_fc_status)" = "1" ] && echo "ENABLED" || echo "DISABLED")"
    echo "Runner:                        $([ "$(check_runner_status)" = "1" ] && echo "ENABLED" || echo "DISABLED")"
    echo ""
    echo "Performance Impact:"
    case "$(nvram_get netadmin_mode safe)" in
        verizon)
            echo "  Current Mode: TTL Spoofing"
            if [ "$(check_ctf_status)" = "1" ]; then
                echo "  WARNING: CTF enabled, expect ~60% throughput reduction"
            fi
            ;;
        verizon-bypass)
            echo "  Current Mode: DPI Bypass (Zapret)"
            echo "  WARNING: Expect ~90% throughput reduction due to NFQUEUE"
            ;;
    esac
}

manage_metrics() {
    local action="${1:-show}"
    sh "$NETADMIN_ROOT/core/metrics.sh" "$action"
}

show_logs() {
    local count="${1:-20}"
    
    if [ -f "$NETADMIN_STATE_LOG" ]; then
        echo "netadmin State Machine Log (last $count entries)"
        echo "================================================="
        tail -n "$count" "$NETADMIN_STATE_LOG"
    else
        echo "No logs available yet"
    fi
}

health_check() {
    echo "Running WAN Health Check..."
    echo ""
    
    local wan_if
    wan_if="$(wan_if_detect)" || {
        echo "ERROR: Cannot detect WAN interface"
        return 1
    }
    
    # Run checks
    echo "[1/5] Checking carrier status..."
    if wan_carrier_up "$wan_if"; then
        echo "  ✓ Link UP"
    else
        echo "  ✗ Link DOWN"
        return 1
    fi
    
    echo "[2/5] Checking IP acquisition..."
    if wan_has_ip "$wan_if"; then
        local ip
        ip="$(ip -4 addr show dev "$wan_if" | grep -oE 'inet [0-9.]+' | awk '{print $2}')"
        echo "  ✓ IP Acquired: $ip"
    else
        echo "  ✗ No IP"
        return 1
    fi
    
    echo "[3/5] Checking default route..."
    if wan_has_default_route; then
        echo "  ✓ Default route present"
    else
        echo "  ✗ No default route"
        return 1
    fi
    
    echo "[4/5] Checking gateway reachability..."
    if wan_gateway_reachable "$wan_if"; then
        echo "  ✓ Gateway reachable"
    else
        echo "  ✗ Gateway unreachable"
        return 1
    fi
    
    echo "[5/5] Checking TCP connectivity..."
    if wan_tcp_health "8.8.8.8" "53" || wan_tcp_health "1.1.1.1" "443"; then
        echo "  ✓ TCP handshake successful"
    else
        echo "  ✗ TCP health check failed"
        return 1
    fi
    
    echo ""
    echo "✓ All health checks passed"
}

verify_rules() {
    local profile
    profile="$(nvram_get netadmin_mode safe)"
    
    echo "Verifying rules for profile: $profile"
    
    if verify_rules_active "$profile"; then
        echo "✓ Rules are active"
        return 0
    else
        echo "✗ Rules are NOT active"
        echo "Attempting to reapply..."
        if apply_rules "$profile"; then
            echo "✓ Rules reapplied successfully"
        else
            echo "✗ Failed to reapply rules"
            return 1
        fi
    fi
}

migrate_from_v21() {
    echo "Migrating from netadmin v2.1 to v3.0"
    echo "====================================="
    
    # Check for v2.1 NVRAM keys
    if ! nvram show | grep -q '^verizon_'; then
        echo "WARNING: No v2.1 configuration found"
        echo "Proceeding with fresh installation..."
    fi
    
    echo "Backing up current configuration..."
    cp -r /jffs/scripts /jffs/scripts.v2.1.backup
    echo "✓ Backup created at /jffs/scripts.v2.1.backup"
    
    # Migrate NVRAM keys
    echo "Migrating NVRAM keys..."
    local old_ttl_mode
    old_ttl_mode="$(nvram_get verizon_ttl_mode off)"
    nvram_set "netadmin_ttl_mode" "$old_ttl_mode"
    
    local old_zapret
    old_zapret="$(nvram_get verizon_zapret 0)"
    nvram_set "netadmin_zapret" "$old_zapret"
    
    nvram_set "netadmin_state" "0"
    nvram_set "netadmin_mode" "safe"
    nvram_commit
    
    echo "✓ Migration complete"
    echo ""
    echo "Next steps:"
    echo "  1. Verify new installation: netadmin show-config"
    echo "  2. Reapply your profile: netadmin profile verizon"
    echo "  3. Check health: netadmin health-check"
}

rollback() {
    echo "Rolling back to last known good state..."
    
    if [ -d /jffs/scripts.v2.1.backup ]; then
        echo "Restoring from v2.1 backup..."
        rm -rf /jffs/scripts
        mv /jffs/scripts.v2.1.backup /jffs/scripts
        echo "✓ Rollback complete"
        echo "The router will use your v2.1 configuration."
        echo "Restart services to apply changes (or reboot)."
    else
        echo "ERROR: No backup found"
        echo "Cannot rollback without backup."
        return 1
    fi
}

main() {
    local command="${1:-help}"
    
    case "$command" in
        profile)
            profile_switch "${2:-safe}"
            ;;
        wan-state)
            show_wan_state
            ;;
        get-state)
            show_state
            ;;
        show-config)
            show_config
            ;;
        show-hardware)
            show_hardware
            ;;
        metrics)
            manage_metrics "${2:-show}"
            ;;
        logs)
            show_logs "${2:-20}"
            ;;
        health-check)
            health_check
            ;;
        verify)
            verify_rules
            ;;
        migrate)
            if [ "${2:-}" = "--from-v2.1" ]; then
                migrate_from_v21
            else
                echo "Usage: netadmin migrate --from-v2.1"
                return 1
            fi
            ;;
        rollback)
            rollback
            ;;
        help|--help|-h)
            show_help
            ;;
        version|--version|-v)
            show_version
            ;;
        *)
            echo "Unknown command: $command"
            show_help
            return 1
            ;;
    esac
}

main "$@"
