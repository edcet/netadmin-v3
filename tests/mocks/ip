#!/bin/sh
# Mock ip command for testing
# Simulates iproute2 ip behavior

set -u

IP_STATE="${IP_STATE:-/tmp/ip_mock_$$}"

# Initialize with default state
if [ ! -f "$IP_STATE" ]; then
    cat > "$IP_STATE" << 'EOF'
interface=eth0
carrier=1
ip=192.168.100.5
gateway=192.168.100.1
route_exists=1
EOF
fi

# Parse command
subcmd="${1:-}"
shift || true

case "$subcmd" in
    addr|address)
        # ip addr show
        if [ "${1:-}" = "show" ]; then
            shift
            dev="${2:-eth0}"

            ip_addr="$(grep '^ip=' "$IP_STATE" | cut -d= -f2)"
            if [ -n "$ip_addr" ]; then
                echo "2: $dev: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500"
                echo "    inet $ip_addr/24 brd 192.168.100.255 scope global $dev"
            else
                echo "2: $dev: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500"
            fi
        fi
        ;;

    route)
        # ip route show
        if [ "${1:-}" = "show" ] || [ "${1:-}" = "" ]; then
            route_exists="$(grep '^route_exists=' "$IP_STATE" | cut -d= -f2)"
            gateway="$(grep '^gateway=' "$IP_STATE" | cut -d= -f2)"

            if [ "$route_exists" = "1" ] && [ -n "$gateway" ]; then
                echo "default via $gateway dev eth0"
                echo "192.168.100.0/24 dev eth0 proto kernel scope link src 192.168.100.5"
            fi
        fi
        ;;

    link)
        # ip link show
        if [ "${1:-}" = "show" ] || [ "${1:-}" = "set" ]; then
            carrier="$(grep '^carrier=' "$IP_STATE" | cut -d= -f2)"

            if [ "$carrier" = "1" ]; then
                echo "2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP"
            else
                echo "2: eth0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc fq_codel state DOWN"
            fi
        fi
        ;;

    *)
        echo "Mock ip: subcommand $subcmd not implemented" >&2
        exit 1
        ;;
esac
